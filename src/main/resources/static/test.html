<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LinkVerse API í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 10px; }
        #notifications { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; }
        .notification { margin: 5px 0; padding: 5px; background: white; border-left: 3px solid #007bff; }
    </style>
</head>
<body>
<h1>LinkVerse API í…ŒìŠ¤íŠ¸</h1>

<!-- ì¸ì¦ ì„¹ì…˜ -->
<div class="section">
    <h3>1. ì‚¬ìš©ì ì¸ì¦</h3>
    <input type="email" id="email" placeholder="ì´ë©”ì¼" value="test@example.com">
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="password123">
    <br>
    <button onclick="register()">íšŒì›ê°€ì…</button>
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="authStatus"></div>
</div>

<!-- ê²Œì‹œë¬¼ ì„¹ì…˜ -->
<div class="section">
    <h3>2. ê²Œì‹œë¬¼ ê¸°ëŠ¥</h3>
    <textarea id="postContent" placeholder="ê²Œì‹œë¬¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <br>
    <button onclick="createPost()">ê²Œì‹œë¬¼ ì‘ì„±</button>
    <button onclick="getFeed()">í”¼ë“œ ì¡°íšŒ</button>
    <div id="posts"></div>
</div>

<!-- ì‹¤ì‹œê°„ ì•Œë¦¼ ì„¹ì…˜ -->
<div class="section">
    <h3>3. ì‹¤ì‹œê°„ ì•Œë¦¼ (SSE)</h3>
    <button onclick="connectSSE()">ì•Œë¦¼ ì—°ê²°</button>
    <button onclick="disconnectSSE()">ì•Œë¦¼ ëŠê¸°</button>
    <div id="sseStatus"></div>
    <div id="notifications"></div>
</div>

<!-- ì¢‹ì•„ìš”/ëŒ“ê¸€ í…ŒìŠ¤íŠ¸ -->
<div class="section">
    <h3>4. ìƒí˜¸ì‘ìš© í…ŒìŠ¤íŠ¸</h3>
    <input type="number" id="targetPostId" placeholder="ê²Œì‹œë¬¼ ID">
    <button onclick="toggleLike()">ì¢‹ì•„ìš” í† ê¸€</button>
    <br>
    <input type="text" id="commentContent" placeholder="ëŒ“ê¸€ ë‚´ìš©">
    <button onclick="addComment()">ëŒ“ê¸€ ì‘ì„±</button>
    <div id="interactions"></div>
</div>

<script>
    let authToken = localStorage.getItem('authToken');
    let eventSource = null;

    // ì¸ì¦ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateAuthStatus() {
        const status = document.getElementById('authStatus');
        status.innerHTML = authToken ?
            'âœ… ë¡œê·¸ì¸ë¨ (í† í°: ' + authToken + ')' :
            'âŒ ë¡œê·¸ì¸ í•„ìš”';
    }

    // íšŒì›ê°€ì…
    async function register() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    username: email.split('@')[0]
                })
            });

            const result = await response.json();
            alert(result.success ? 'íšŒì›ê°€ì… ì„±ê³µ!' : 'íšŒì›ê°€ì… ì‹¤íŒ¨: ' + result.message);
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // ë¡œê·¸ì¸
    async function login() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            const result = await response.json();

            if (result.success) {
                authToken = result.data.token;
                localStorage.setItem('authToken', authToken);
                alert('ë¡œê·¸ì¸ ì„±ê³µ!');
                updateAuthStatus();
            } else {
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + result.message);
            }
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        authToken = null;
        localStorage.removeItem('authToken');
        disconnectSSE();
        updateAuthStatus();
        alert('ë¡œê·¸ì•„ì›ƒë¨');
    }

    // ê²Œì‹œë¬¼ ì‘ì„±
    async function createPost() {
        if (!authToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        const content = document.getElementById('postContent').value;
        if (!content) {
            alert('ê²Œì‹œë¬¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        try {
            const response = await fetch('/api/posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({
                    content: content,
                    visibility: 'PUBLIC'
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('ê²Œì‹œë¬¼ ì‘ì„± ì„±ê³µ!');
                document.getElementById('postContent').value = '';
                getFeed(); // í”¼ë“œ ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ê²Œì‹œë¬¼ ì‘ì„± ì‹¤íŒ¨: ' + result.message);
            }
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // í”¼ë“œ ì¡°íšŒ
    async function getFeed() {
        if (!authToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        try {
            const response = await fetch('/api/feed', {
                headers: { 'Authorization': 'Bearer ' + authToken }
            });

            const result = await response.json();

            if (result.success) {
                const postsDiv = document.getElementById('posts');
                postsDiv.innerHTML = '<h4>ìµœê·¼ ê²Œì‹œë¬¼ë“¤:</h4>';

                result.data.forEach(post => {
                    postsDiv.innerHTML += `
                            <div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px;">
                                <strong>ID: ${post.id}</strong> - ${post.user.username}<br>
                                ${post.content}<br>
                                <small>â¤ï¸ ${post.likesCount} | ğŸ’¬ ${post.commentsCount}</small>
                            </div>
                        `;
                });
            }
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // SSE ì—°ê²°
    function connectSSE() {
        console.log('=== connectSSE í•¨ìˆ˜ í˜¸ì¶œë¨ ===');

        if (!authToken) {
            console.log('í† í° ì—†ìŒ');
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        console.log('í† í° ìˆìŒ:', authToken);

        if (eventSource) {
            console.log('ì´ë¯¸ ì—°ê²°ë¨');
            alert('ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤');
            return;
        }

        console.log('EventSource ìƒì„± ì‹œë„...');
        eventSource = new EventSource('/api/notifications/stream?token=' + authToken);
        console.log('EventSource ìƒì„±ë¨:', eventSource);

        eventSource.onmessage = function(event) {
            console.log('ì¼ë°˜ ë©”ì‹œì§€ ë°›ìŒ:', event.data);
            // UIì—ë„ í‘œì‹œ
            document.getElementById('notifications').innerHTML +=
                '<div class="notification">ë©”ì‹œì§€: ' + event.data + '</div>';
        };

        eventSource.onopen = function() {
            document.getElementById('sseStatus').innerHTML = 'ğŸŸ¢ SSE ì—°ê²°ë¨';
        };

        eventSource.addEventListener('notification', function(event) {
            console.log('=== ì•Œë¦¼ ë°›ìŒ ===');
            console.log('ì›ë³¸ ë°ì´í„°:', event.data);

            try {
                const notification = JSON.parse(event.data);
                console.log('íŒŒì‹±ëœ ë°ì´í„°:', notification);
                addNotificationToUI(notification);
            } catch (error) {
                console.error('JSON íŒŒì‹± ì—ëŸ¬:', error);
                console.error('ë¬¸ì œ ë°ì´í„°:', event.data);
            }
        });

        eventSource.addEventListener('heartbeat', function(event) {
            console.log('Heartbeat:', event.data);
        });

        eventSource.onerror = function(event) {
            document.getElementById('sseStatus').innerHTML = 'ğŸ”´ SSE ì—°ê²° ì˜¤ë¥˜';
            console.error('SSE Error:', event);
        };
    }

    // SSE ì—°ê²° í•´ì œ
    function disconnectSSE() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
            document.getElementById('sseStatus').innerHTML = 'âš« SSE ì—°ê²° ëŠê¹€';
        }
    }

    // ì•Œë¦¼ì„ UIì— ì¶”ê°€
    function addNotificationToUI(notification) {
        const notificationsDiv = document.getElementById('notifications');
        const notificationEl = document.createElement('div');
        notificationEl.className = 'notification';
        notificationEl.innerHTML = `
                <strong>${notification.type}</strong>: ${notification.content}<br>
                <small>${new Date(notification.createdAt).toLocaleString()}</small>
            `;
        notificationsDiv.insertBefore(notificationEl, notificationsDiv.firstChild);
    }

    // ì¢‹ì•„ìš” í† ê¸€
    async function toggleLike() {
        if (!authToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        const postId = document.getElementById('targetPostId').value;
        if (!postId) {
            alert('ê²Œì‹œë¬¼ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        try {
            const response = await fetch(`/api/likes/POST/${postId}`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + authToken }
            });

            const result = await response.json();
            document.getElementById('interactions').innerHTML =
                result.success ? 'âœ… ì¢‹ì•„ìš” ì²˜ë¦¬ë¨' : 'âŒ ì‹¤íŒ¨: ' + result.message;
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // ëŒ“ê¸€ ì‘ì„±
    async function addComment() {
        if (!authToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        const postId = document.getElementById('targetPostId').value;
        const content = document.getElementById('commentContent').value;

        if (!postId || !content) {
            alert('ê²Œì‹œë¬¼ IDì™€ ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        try {
            const response = await fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                },
                body: JSON.stringify({
                    postId: parseInt(postId),
                    content: content
                })
            });

            const result = await response.json();
            document.getElementById('interactions').innerHTML =
                result.success ? 'âœ… ëŒ“ê¸€ ì‘ì„±ë¨' : 'âŒ ì‹¤íŒ¨: ' + result.message;

            if (result.success) {
                document.getElementById('commentContent').value = '';
            }
        } catch (error) {
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
        authToken = localStorage.getItem('authToken');
        updateAuthStatus();
    };
</script>
</body>
</html>